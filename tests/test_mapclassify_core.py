import unittest
import requests
import simplejson
from geobricks_common.core.log import logger
from geobricks_mapclassify.config.config import config
from geobricks_mapclassify.core.mapclassify import MapClassify

log = logger(__file__)


# TODO: handle the distribution_url in the config file
# fake distribution_url
distribution_url = "http://localhost:8080/mapclassify/download/sld/"

class GeobricksTest(unittest.TestCase):

    def test_jenks(self):

        d = {
            "colorramp": "Reds",
            "classificationtype": "Jenks_Caspall_Forced",
            # "ranges": [512094,512094*2,512094*3,512094*4,512094*5],
            # "ranges": [512094, 512094*2],
            # "reverse": True,
            # "colors": ["#00023", "#bbb234", "#ccc345"],
            "joindata": [{"1": "2.0520652E8"},{"2":"512094.0"},{"4":"320.0"},{"7":"37608.0"},{"9":"1563450.0"},{"10":"1161115.0"},{"16":"5.15E7"},{"18":"78730.0"},{"19":"426050.6009"},{"21":"1.1782549E7"},{"23":"20505.0"},{"25":"4200.0"},{"26":"1850.0"},{"27":"54900.0"},{"28":"2.8767E7"},{"29":"41454.0"},{"32":"194094.0"},{"37":"42500.0"},{"38":"4620730.0"},{"39":"330000.0"},{"40":"130307.0"},{"41":"2.036122E8"},{"44":"2048938.0"},{"45":"29000.0"},{"46":"1700.0"},{"48":"224570.0"},{"49":"672600.0"},{"52":"4833.0"},{"53":"206943.0"},{"56":"824000.0"},{"58":"1516045.0"},{"59":"6100000.0"},{"60":"36254.0"},{"66":"5000.0"},{"68":"82000.0"},{"69":"2020.0"},{"74":"1700.0"},{"75":"69704.0"},{"81":"569524.0"},{"84":"227000.0"},{"89":"32051.0"},{"90":"2053000.0"},{"91":"823800.0"},{"93":"169299.66"},{"95":"49656.0"},{"97":"9800.0"},{"100":"1.592E8"},{"101":"7.1279709E7"},{"102":"2900000.0"},{"103":"451849.0"},{"106":"1339000.0"},{"107":"1934154.0"},{"108":"344300.0"},{"109":"31.0"},{"110":"1.0758E7"},{"113":"27220.0"},{"114":"146696.0"},{"115":"9390000.0"},{"116":"2901000.0"},{"117":"5631689.0"},{"120":"3415000.0"},{"123":"238000.0"},{"129":"3610626.0"},{"130":"125156.0"},{"131":"2626881.0"},{"133":"2211920.0"},{"136":"192000.0"},{"137":"646.0"},{"138":"179776.0"},{"143":"37716.0"},{"144":"351000.0"},{"145":"165.0"},{"149":"4504503.0"},{"154":"27921.0"},{"157":"377470.0699"},{"158":"40000.0"},{"159":"4700000.0"},{"165":"6798100.0"},{"166":"287395.0"},{"168":"1300.0"},{"169":"617397.0"},{"170":"3050934.028"},{"171":"1.8439406E7"},{"174":"168300.0"},{"175":"209717.0"},{"176":"87000.0"},{"181":"700.0"},{"182":"260.0"},{"183":"54646.0"},{"184":"93746.0"},{"185":"934943.0"},{"195":"423482.0"},{"197":"1255559.0"},{"201":"1970.0"},{"202":"3000.0"},{"203":"851500.0"},{"206":"25000.0"},{"207":"262029.0"},{"208":"98000.0"},{"209":"105.0"},{"213":"130000.0"},{"214":"1594320.0"},{"215":"2194750.0"},{"216":"3.60626E7"},{"217":"164998.0"},{"220":"2859.0"},{"223":"900000.0"},{"226":"214000.0"},{"230":"145050.0"},{"231":"8613094.0"},{"233":"305382.0"},{"234":"1359000.0"},{"235":"340219.0"},{"236":"1005000.01"},{"237":"4.403929126E7"},{"238":"184210.0"},{"250":"355000.0"},{"251":"44747.0"}],
            "classificationtype": "percentiles",
            "doublecounting": False,
            "decimalvalues": 0,
            "joincolumn": "adm0_code",

            # what to set to create or not the sld?
            "jointype": "shaded",
            "layers": "fenix:gaul0_2015_4326"
        }
        mapclassify = MapClassify(config)
        result = mapclassify.classify(d, distribution_url)
        self.assertEqual(result['legend'], [{'color': '#FEE5D9', 'range': 115.0, 'codes': ['109', '209'], 'label': '&lt;= 115.0'}, {'color': '#FCBBA1', 'range': 2523.0, 'codes': ['4', '26', '46', '69', '74', '137', '145', '168', '181', '182', '201'], 'label': '&lt;= 2523.0'}, {'color': '#FC9272', 'range': 262029.0, 'codes': ['7', '18', '23', '25', '27', '29', '32', '37', '40', '45', '48', '52', '53', '60', '66', '68', '75', '84', '89', '93', '95', '97', '113', '114', '123', '130', '136', '138', '143', '154', '158', '174', '175', '176', '183', '184', '202', '206', '207', '208', '213', '217', '220', '226', '230', '238', '251'], 'label': '&lt;= 262029.0'}, {'color': '#FB6A4A', 'range': 8923856.0, 'codes': ['2', '9', '10', '19', '38', '39', '44', '49', '56', '58', '59', '81', '90', '91', '102', '103', '106', '107', '108', '116', '117', '120', '129', '131', '133', '144', '149', '157', '159', '165', '166', '169', '170', '185', '195', '197', '203', '214', '215', '223', '231', '233', '234', '235', '236', '250'], 'label': '&lt;= 8923856.0'}, {'color': '#DE2D26', 'range': 196506248.0, 'codes': ['16', '21', '28', '100', '101', '110', '115', '171', '216', '237'], 'label': '&lt;= 196506248.0'}, {'color': '#A50F15', 'range': 196506248.0, 'codes': ['1', '41'], 'label': '&gt; 196506248.0'}])


def run_test():
    suite = unittest.TestLoader().loadTestsFromTestCase(GeobricksTest)
    unittest.TextTestRunner(verbosity=2).run(suite)

if __name__ == '__main__':
    run_test()


